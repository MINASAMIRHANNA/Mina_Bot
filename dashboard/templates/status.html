<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradePro | System Status</title>
  <style>
    :root { --bg:#0d1117; --panel:#161b22; --accent:#ffd700; --border:#30363d; --text:#c9d1d9; --muted:#8b949e; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: 'Segoe UI', sans-serif; padding:18px;}
    .container{ max-width:1200px; margin:0 auto; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; border-bottom:1px solid var(--border); padding-bottom:14px; margin-bottom:16px; }
    .top h1{ margin:0; color:var(--accent); font-size:1.4rem; }
    .btn{ background:var(--accent); border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; color:#000; }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); font-weight:600; }
    .btn.secondary:hover{ border-color:var(--accent); }
    .grid{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .card h3{ margin:0 0 10px 0; color:var(--accent); font-size:0.95rem; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:8px; font-size:0.88rem; }
    .k{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:0.75rem; font-weight:700; }
    .ok{ background:#1b4332; color:#7ee787; }
    .warn{ background:#3b2f0b; color:#d29922; }
    .err{ background:#4a0f0f; color:#ff7b72; }
    .section{ margin-top:14px; }
    .statusbar{ display:none; margin: 10px 0 14px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--panel); }
    .statusbar a{ color:var(--accent); text-decoration:none; }
    .actions{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-top:12px; }
    @media (max-width: 980px){ .actions{ grid-template-columns: 1fr; } }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, select{ background:#0d1117; color:#f0f6fc; border:1px solid var(--border); padding:10px 10px; border-radius:8px; outline:none; }
    label{ color:var(--muted); font-size:0.75rem; font-weight:700; text-transform:uppercase; }
    .small{ font-size:0.82rem; color:var(--muted); }
    pre{ background:#0d1117; border:1px solid var(--border); border-radius:10px; padding:10px; overflow:auto; font-size:0.82rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>System Status & Maintenance</h1>
      <div class="row">
        <a class="btn secondary" href="/">Back</a>
        <button class="btn secondary" onclick="toggleRaw()">Toggle Raw JSON</button>
        <button class="btn" onclick="refreshStatus()">Refresh</button>
      </div>
    </div>

    <div id="statusbar" class="statusbar"></div>

    <div class="grid">
      <div class="card">
        <h3>Summary</h3>
        <div class="kv">
          <div class="k">Time (UTC)</div><div class="mono" id="timeUtc">-</div>
          <div class="k">Overall</div><div id="overall">-</div>
          <div class="k">Bot (inferred)</div><div id="botAlive">-</div>
          <div class="k">Dashboard</div><div id="dashOk">-</div>
          <div class="k">Binance</div><div id="binanceOk">-</div>
        </div>
      </div>

      <div class="card">
        <h3>Database</h3>
        <div class="kv">
          <div class="k">DB Path</div><div class="mono" id="dbPath">-</div>
          <div class="k">Exists</div><div id="dbExists">-</div>
          <div class="k">Size</div><div class="mono" id="dbSize">-</div>
          <div class="k">Integrity</div><div class="mono" id="dbIntegrity">-</div>
          <div class="k">Counts</div><div class="mono" id="dbCounts">-</div>
        </div>
        <div class="section small" id="dbMultiple"></div>
      </div>

      <div class="card">
        <h3>Recent Activity</h3>
        <div class="kv">
          <div class="k">Last Log</div><div class="mono" id="lastLog">-</div>
          <div class="k">Last Snapshot</div><div class="mono" id="lastSnap">-</div>
          <div class="k">Last Signal</div><div class="mono" id="lastSignal">-</div>
          <div class="k">Last Command</div><div class="mono" id="lastCmd">-</div>
        </div>
      </div>
    </div>

    <div class="section card">
      <h3>Maintenance Controls</h3>
      <div class="small">These actions operate on the configured DB (<span class="mono">DB_FILE</span>). Most are safe prunes. “Send Command” queues a command for the bot to execute when it’s running.</div>

      <div class="actions">
        <div class="card">
          <h3>Prune Snapshots</h3>
          <div class="row">
            <div style="flex:1">
              <label>Days</label>
              <input id="pruneSnapDays" type="number" min="1" value="30" />
            </div>
            <button class="btn" onclick="runAction('prune_equity_history', {days: getVal('pruneSnapDays')})">Run</button>
          </div>
        </div>

        <div class="card">
          <h3>Prune Logs</h3>
          <div class="row">
            <div style="flex:1">
              <label>Days</label>
              <input id="pruneLogDays" type="number" min="1" value="14" />
            </div>
            <button class="btn" onclick="runAction('prune_logs', {days: getVal('pruneLogDays')})">Run</button>
          </div>
        </div>

        <div class="card">
          <h3>Prune Signals</h3>
          <div class="row">
            <div style="flex:1">
              <label>Keep Last</label>
              <input id="keepSignals" type="number" min="50" value="500" />
            </div>
            <button class="btn" onclick="runAction('prune_signals', {keep_last: getVal('keepSignals')})">Run</button>
          </div>
        </div>

        <div class="card">
          <h3>Reset Kill Switch</h3>
          <div class="row">
            <button class="btn" onclick="runAction('reset_kill_switch', {})">Reset</button>
          </div>
          <div class="small">Sets <span class="mono">kill_switch=0</span> in settings.</div>
        </div>

        <div class="card">
          <h3>Clear Finished Commands</h3>
          <div class="row">
            <div style="flex:1">
              <label>Older Than (Days)</label>
              <input id="clearCmdDays" type="number" min="1" value="7" />
            </div>
            <button class="btn" onclick="runAction('clear_commands', {days: getVal('clearCmdDays')})">Run</button>
          </div>
        </div>

        <div class="card">
          <h3>Send Bot Command</h3>
          <label>Command</label>
          <select id="botCmd">
            <option value="RELOAD_CONFIG">RELOAD_CONFIG</option>
            <option value="CLOSE_ALL_POSITIONS">CLOSE_ALL_POSITIONS</option>
          </select>
          <div style="height:8px"></div>
          <button class="btn" onclick="sendCommand()">Queue</button>
          <div class="small">This only queues. Bot must be running to consume it.</div>
        </div>
      </div>

      <div class="section">
        <div id="rawWrap" style="display:none">
          <h3>Raw Status JSON</h3>
          <pre id="rawJson">{}</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    function pill(ok, labelOk="OK", labelBad="DOWN", labelMaybe="N/A") {
      if (ok === true) return `<span class="pill ok">${labelOk}</span>`;
      if (ok === false) return `<span class="pill err">${labelBad}</span>`;
      return `<span class="pill warn">${labelMaybe}</span>`;
    }

    function showBar(kind, html) {
      const el = document.getElementById('statusbar');
      el.style.display = html ? 'block' : 'none';
      el.innerHTML = html || '';
      el.className = 'statusbar ' + (kind || '');
    }

    function getVal(id){ return document.getElementById(id).value; }

    function fmtBytes(n){
      n = Number(n || 0);
      if (!Number.isFinite(n) || n <= 0) return "0";
      const units = ["B","KB","MB","GB"];
      let i = 0;
      while (n >= 1024 && i < units.length-1) { n /= 1024; i++; }
      return `${n.toFixed(2)} ${units[i]}`;
    }

    async function fetchJson(url, opts={}){
      const res = await fetch(url, { credentials: 'include', ...opts });
      if (res.status === 401) {
        showBar('warn', 'Unauthorized. Please <a href="/login">login</a> then retry.');
        throw new Error("Unauthorized");
      }
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t}`);
      }
      return await res.json();
    }

    async function refreshStatus(){
      showBar('', '');
      try{
        const st = await fetchJson('/api/status');
        document.getElementById('timeUtc').textContent = st.time_utc || '-';

        const problems = (st.summary && st.summary.problems) ? st.summary.problems : [];
        document.getElementById('overall').innerHTML = st.summary && st.summary.ok ? pill(true, "OK") : pill(false, "ISSUES");
        if (problems.length) {
          showBar('err', '<b>Issues:</b><br>' + problems.map(p => `• ${p}`).join('<br>'));
        }

        document.getElementById('botAlive').innerHTML = pill(st.bot && st.bot.alive_inferred, "ACTIVE", "INACTIVE", "UNKNOWN");
        document.getElementById('dashOk').innerHTML = pill(true, "RUNNING"); // this page is served by dashboard itself
        document.getElementById('binanceOk').innerHTML = pill(st.binance && st.binance.ok, "OK", "FAIL", "N/A");

        const db = st.database || {};
        document.getElementById('dbPath').textContent = db.db || '-';
        document.getElementById('dbExists').innerHTML = pill(!!db.exists, "YES", "NO");
        document.getElementById('dbSize').textContent = fmtBytes(db.size_bytes || 0);
        document.getElementById('dbIntegrity').textContent = db.integrity_message || '-';
        document.getElementById('dbCounts').textContent = JSON.stringify(db.counts || {}, null, 0);

        document.getElementById('lastLog').textContent = db.last_log_time || '-';
        document.getElementById('lastSnap').textContent = db.last_snapshot_time || '-';
        document.getElementById('lastSignal').textContent = db.last_signal_time || '-';
        document.getElementById('lastCmd').textContent = db.last_command_time || '-';

        // multiple DB warning
        const known = db.known_db_files || [];
        if (known.length) {
          const existing = known.filter(x => x.exists);
          if (existing.length > 1) {
            document.getElementById('dbMultiple').innerHTML =
              `<span class="pill warn">MULTIPLE DB FILES</span> ` +
              existing.map(x => `<div class="mono">${x.path} (${fmtBytes(x.size_bytes)})</div>`).join('');
          } else {
            document.getElementById('dbMultiple').innerHTML = '';
          }
        }

        // Raw JSON
        document.getElementById('rawJson').textContent = JSON.stringify(st, null, 2);
      }catch(e){
        console.error(e);
        if (String(e).includes("Unauthorized")) return;
        showBar('err', 'Error: <span class="mono">' + String(e) + '</span>');
      }
    }

    function toggleRaw(){
      const w = document.getElementById('rawWrap');
      w.style.display = (w.style.display === 'none') ? 'block' : 'none';
    }

    async function runAction(action, params){
      showBar('', '');
      try{
        const res = await fetchJson('/api/maintenance', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ action, params })
        });
        showBar(res.ok ? 'ok' : 'err', `<b>${res.ok ? 'OK' : 'FAILED'}</b>: ${res.message}<br><span class="mono">${JSON.stringify(res.details || {})}</span>`);
        await refreshStatus();
      }catch(e){
        console.error(e);
        if (String(e).includes("Unauthorized")) return;
        showBar('err', 'Error: <span class="mono">' + String(e) + '</span>');
      }
    }

    async function sendCommand(){
      const cmd = document.getElementById('botCmd').value;
      // Sprint 7: queue command directly (does not rely on project_doctor)
      showBar('', '');
      try{
        const res = await fetchJson('/api/commands/queue', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ cmd, params: {} })
        });
        showBar(res.ok ? 'ok' : 'err', `<b>${res.ok ? 'QUEUED' : 'FAILED'}</b>: ${res.message || ''}<br><span class="mono">command_id=${res.command_id || 0}</span>`);
        await refreshStatus();
      }catch(e){
        console.error(e);
        if (String(e).includes("Unauthorized")) return;
        showBar('err', 'Error: <span class="mono">' + String(e) + '</span>');
      }
    }

    // Init
    window.addEventListener('DOMContentLoaded', async () => {
      await refreshStatus();
      // Auto-refresh every 60s
      setInterval(refreshStatus, 60000);
    });
  </script>
</body>
</html>
